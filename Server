package Final;

import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.*;
import java.util.Random;
import Final.LinkedList;

public class Server {
	private static LinkedList<DataOutputStream> clients = new LinkedList<>();
	private static String firstMessage;

	static class ClientRequest implements Runnable {
		Socket connectionSocket;

		public ClientRequest(Socket socket) {
			this.connectionSocket = socket;
		}

		@Override
		public void run() {
			try {
				process();
			} catch (Exception e) {
				System.out.println(e);
			}
		}

		private void process() throws Exception {
			BufferedReader br = new BufferedReader(new InputStreamReader(connectionSocket.getInputStream()));
			DataOutputStream os = new DataOutputStream(connectionSocket.getOutputStream());
			Random rand = new Random();
			
			Iterator <DataOutputStream> osIterator = clients.getIterator();

			os.writeBytes("Welcome to \"Unscramble the Message\"! Enter your name: \r\n");
			String clientName = br.readLine();
			
			os.writeBytes("Hello " + clientName + "! Type \"{quit}\" to exit.\r\n");

			for (DataOutputStream outputStream : clients) {
				outputStream.writeBytes(clientName + " joined the game!\r\n");
				clients.add(outputStream);
			}			

			String clientMessage = null;
			while (true) {
				while (((clientMessage = br.readLine()) != "{quit}") || osIterator.hasNext()) {
					String[] array = clientMessage.split(" ");

					// for loop code block influenced by
					// https://www.journaldev.com/32661/shuffle-array-java
					for (int i = 0; i < array.length; i++) {
						int randIndex = rand.nextInt(array.length);
						String temp = array[randIndex];
						array[randIndex] = array[i];
						array[i] = temp;
					}

					int randomInt = rand.nextInt(100);
					if (randomInt > 80) {
						array[rand.nextInt(array.length)] = "";
					}

					if (osIterator.hasNext()) {
						DataOutputStream outputStream = osIterator.next();
						outputStream.writeBytes(array.toString() + "\r\n");
					}
				}
				if ((clientMessage = br.readLine()) == "{quit}") {
					osIterator.remove();
					os.writeBytes("You have left the game.\r\n");
				}
				else if (!osIterator.hasNext()) {
					for (DataOutputStream outputStream : clients) {
						outputStream.writeBytes("The original message was: " + firstMessage);
					}
				}
			}
		}
	}

	public static void main(String[] args) throws IOException {
		ServerSocket serverSocket = new ServerSocket(1234);
		System.out.println("Waiting for connections...");

		while (true) {
			Socket connectionSocket = serverSocket.accept();

			ClientRequest request = new ClientRequest(connectionSocket);

			Thread thread = new Thread(request);
			thread.start();

		}

	}

}
